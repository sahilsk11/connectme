<!DOCTYPE html>
<html>
	<head>
		<title>ConnectMe</title>
		<meta name = "viewport" content="initial-scale=1.0">
		<meta name="author" content="Sahil Kapur">

		<link href="../CSS/bootstrap.css" rel="stylesheet">
		<link href="../CSS/organize.css" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css?family=Questrial|Raleway" rel="stylesheet">
		<link href="../Images/icon.png" rel="icon">
		<script src="../js/XHRequest.js"></script>
		<script src="../js/cookiesk.js"></script>
		<script src="../js/jquery-2.2.4.min.js"></script>
		<script src="../js/bootstrap.js"></script>
		<script>
			var code;
			var user;
			var loggedin = false;

			function getCode() {
				var url = new URL(window.location.href);
				code = url.searchParams.get("code");
				//user = url.searchParams.get("user");
				//if (user != null) {
				//	reload = false;
				//}
			}

			function getEvent() {
				XHRequest.createRequest({
					success: displayEvent, 
					method: "GET",
					params: {
						command: "single_event",
						code: code
					},
					url: "../scripts/connect_database.py"
				});
			}

			function displayEvent(xhr, xhrConfig) {
				var events = JSON.parse(xhr.responseText);
				var name = events["name"];
				var date = events["group_date"];
				var host = events["host"];
				var host_id = events["host_id"];
				var code = events["uid"];
				var categories = events["categories"];
				var description = events["description"];
				var location = events["location"];
				var maximum_people = events["maximum_people"];
				var facebook_link = events["fb_url"];
				document.getElementById("name").innerHTML = name;
				document.getElementById("date").innerHTML = date;
				document.getElementById("description").innerHTML = description;

				document.getElementById("map").src = "//www.google.com/maps/embed/v1/place?q="+location+"&zoom=17&key=AIzaSyBeEZCy4cxgcCAh17K7RswTSI6wEjaMweE";
				document.getElementById("host-name").innerHTML = "Host: " + host["name"];
				document.getElementById("host-name").href = "../newaccount?code="+host_id;
				if (host["email"] != undefined) {
					document.getElementById("host-email").innerHTML = host["email"];
				}
				if (host["email"] != undefined) {
					document.getElementById("host-phone").innerHTML = host["phone"];
				}
			}

			function getAccount() {
				var account = getUserCookie("account");
				console.log(account);
				user = account;
			}

			function getUser() {
				if (user != "") {
					XHRequest.createRequest({
						success: allowUser, 
						method: "GET",
						params: {
							command: "user_information",
							code: user
						},
						url: "../scripts/connect_database.py"
					});
				}
			}

			function allowUser(xhr, xhrConfig) {
				var profile = JSON.parse(xhr.responseText);
				var firstName = profile["first_name"];
				console.log(firstName);
				var lastName = profile["last_name"];
				var userName = profile["username"];
				console.log("Received user information");
				loggedin = true;
			}

			function showMessage() {
				if (loggedin) {
					document.getElementById("confirm-application").innerHTML = '<br>\
						<p>By confirming, you allow ConnectMe to send the host of this event your email, phone number, and other relevant links provided to us. (We do not send birthday)</p>\
						<button class="btn btn-success" onclick="sendApplication()">Confirm</button>';
				}
				else {
					document.getElementById("confirm-application").innerHTML = "You are not logged in. Please <a href='../login'>log in to apply.</a>";
				}
			}

			function sendApplication() {
				XHRequest.createRequest({
					success: sendUserToMain, 
					method: "GET",
					params: {
						command: "apply-user",
						code: code,
						username: user
					},
					url: "../scripts/connect_database.py"
				});
			}

			function sendUserToMain(xhr, xhrConfig) {
				alert("You have signed up for this event.");
				window.location = "../";
			}
			
			function run() {
				getCode();
				getEvent();
				getAccount();
				getUser();
			}

		</script>
	</head>

	<body onload="run()">
		<nav class="theme-color navbar navbar-inverse">
			<div class="container-fluid">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
			      		<span class="sr-only">Toggle navigation</span>
			      		<span class="icon-bar"></span>
			      		<span class="icon-bar"></span>
			      		<span class="icon-bar"></span>
		        	</button>
	    			<a href="../" class="navbar-brand">
	    				<p class="title-font">ConnectMe</p>
	    				<img src="" class="">
	    			</a>
				</div>
	    		<div id="navbar" class="collapse navbar-collapse">
	    			<ul class="nav navbar-nav theme-color title-font">
	    				<li><a class="theme-color" href="../user">Profile</a></li>
	    				<li><a class="theme-color" href="../create">Create Event</a></li>
	    				<li><a class="theme-color" href="../newaccount">Create Account</a></li>
	    				<li ><a class="theme-color" href="../login">Log In</a></li>
	    			</ul>
	    		</div>
	 		</div>
		</nav>

		<h1 class="title-font text-center" id="name"></h1>
		<h5 class="title-font text-center" id="date"></h5>

		<p class="lead description-field center" id="description"></p>

		<iframe width="100%" height="300px" id="map"></iframe>

		<h1 class="title-font text-center">Host Information</h1>
		<div class="title-font container-fluid">
			<h3 id="host-name"></h3>
			<h3 id="host-email"></h3>
			<h3 id="host-phone"></h3>
		</div>

		<button id="apply-button" onclick="showMessage()" class="btn btn-primary">Apply for Event</button>

		<div id="confirm-application">

		</div>

	</body>
</html>